import { GeminiProvider } from './aiProviders/geminiProvider.js';

export class SmartInputProcessor {
  constructor(apiKey, model = 'gemini-1.5-flash') {
    this.gemini = new GeminiProvider(apiKey, model);
  }

  async processUserIntent(userInput) {
    try {
      const prompt = `
ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì¼ë°˜ì ì¸ ìš”ì²­ì„ êµ¬ì²´ì ì¸ ì›¹ ìë™í™” ëª…ë ¹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

**ì¤‘ìš”í•œ ë³€í™˜ ê·œì¹™:**
1. **ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ ê´€ë ¨**: 
   - "ì •ì¹˜ê¸°ì‚¬ëŠ” ë­ê°€ ìˆì–´?" â†’ "ë„¤ì´ë²„ ë‰´ìŠ¤ ì •ì¹˜ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜"
   - "IT ë‰´ìŠ¤ ë³´ì—¬ì¤˜" â†’ "ë„¤ì´ë²„ ë‰´ìŠ¤ IT ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜"
   - "ê²½ì œ ë‰´ìŠ¤ëŠ”?" â†’ "ë„¤ì´ë²„ ë‰´ìŠ¤ ê²½ì œ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜"

2. **ì„¸ê³„/êµ­ì œ ë‰´ìŠ¤ ê´€ë ¨**:
   - "ë‹¤ë¥¸ ë‚˜ë¼ì—ëŠ” ë³„ì¼ ì—†ì–´?" â†’ "ë„¤ì´ë²„ ë‰´ìŠ¤ ì„¸ê³„ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜"
   - "ì„¸ê³„ ë‰´ìŠ¤ëŠ”?" â†’ "ë„¤ì´ë²„ ë‰´ìŠ¤ ì„¸ê³„ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜"
   - "ì™¸êµ­ ë‰´ìŠ¤ ë³´ì—¬ì¤˜" â†’ "ë„¤ì´ë²„ ë‰´ìŠ¤ ì„¸ê³„ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜"

3. **ë‚ ì”¨ ê´€ë ¨**: "ë„¤ì´ë²„ì—ì„œ [ì§€ì—­] ë‚ ì”¨ ê²€ìƒ‰í•´ì¤˜"
4. **ì‡¼í•‘ ê´€ë ¨**: "ì¿ íŒ¡ì—ì„œ [ìƒí’ˆ] ê²€ìƒ‰í•´ì¤˜"
5. **ì¼ë°˜ ê²€ìƒ‰**: "êµ¬ê¸€ì—ì„œ [ê²€ìƒ‰ì–´] ê²€ìƒ‰í•´ì¤˜"

**í•µì‹¬ ì›ì¹™**: ë‰´ìŠ¤ ê´€ë ¨ ì§ˆë¬¸ì€ ë„¤ì´ë²„ ë‰´ìŠ¤ì˜ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë¡œ ì§ì ‘ ì´ë™í•˜ëŠ” ê²ƒì´ íš¨ìœ¨ì ì…ë‹ˆë‹¤.

ì‚¬ìš©ì ì…ë ¥: "${userInput}"
ë³€í™˜ëœ ëª…ë ¹:
`;

      const response = await this.gemini.generateResponse(prompt);

      // ì‘ë‹µì—ì„œ ëª…ë ¹ì–´ ì¶”ì¶œ
      const command = this.extractCommand(response);

      return {
        success: true,
        originalInput: userInput,
        processedCommand: command,
        reasoning: response
      };

    } catch (error) {
      return {
        success: false,
        originalInput: userInput,
        processedCommand: userInput, // ë³€í™˜ ì‹¤íŒ¨ì‹œ ì›ë³¸ ì‚¬ìš©
        error: error.message
      };
    }
  }

  extractCommand(response) {
    // ì‘ë‹µì—ì„œ ëª…ë ¹ì–´ ë¶€ë¶„ë§Œ ì¶”ì¶œ
    const lines = response.split('\n');
    for (const line of lines) {
      if (line.includes('ë„¤ì´ë²„') || line.includes('êµ¬ê¸€') || line.includes('ì¿ íŒ¡') || 
          line.includes('ê²€ìƒ‰') || line.includes('ë³´ì—¬ì¤˜') || line.includes('ì´ë™') || line.includes('ì¹´í…Œê³ ë¦¬')) {
        return line.trim();
      }
    }
    
    // ëª…í™•í•œ ëª…ë ¹ì–´ê°€ ì—†ìœ¼ë©´ ì›ë³¸ ë°˜í™˜
    return response.trim();
  }

  // ì¼ë°˜ì ì¸ íŒ¨í„´ ë§¤ì¹­ (AI ì—†ì´ë„ ì‘ë™) - ì¹´í…Œê³ ë¦¬ ì§ì ‘ ì´ë™ìœ¼ë¡œ ê°œì„ 
  static getCommonPatterns() {
    return {
      'ë‚ ì”¨': 'ë„¤ì´ë²„ì—ì„œ ì„œìš¸ ë‚ ì”¨ ê²€ìƒ‰í•´ì¤˜',
      'ë‰´ìŠ¤': 'ë„¤ì´ë²„ ë‰´ìŠ¤ì—ì„œ ìµœì‹  ë‰´ìŠ¤ í—¤ë“œë¼ì¸ ë³´ì—¬ì¤˜',
      'IT ë‰´ìŠ¤': 'ë„¤ì´ë²„ ë‰´ìŠ¤ IT ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'IT': 'ë„¤ì´ë²„ ë‰´ìŠ¤ IT ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ê¸°ìˆ  ë‰´ìŠ¤': 'ë„¤ì´ë²„ ë‰´ìŠ¤ IT ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì •ì¹˜ê¸°ì‚¬': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì •ì¹˜ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì •ì¹˜ ë‰´ìŠ¤': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì •ì¹˜ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì •ì¹˜': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì •ì¹˜ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ê²½ì œ ë‰´ìŠ¤': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ê²½ì œ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ê²½ì œ': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ê²½ì œ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì‚¬íšŒ ë‰´ìŠ¤': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì‚¬íšŒ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì‚¬íšŒ': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì‚¬íšŒ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ìŠ¤í¬ì¸  ë‰´ìŠ¤': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ìŠ¤í¬ì¸  ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ìŠ¤í¬ì¸ ': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ìŠ¤í¬ì¸  ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì—°ì˜ˆ ë‰´ìŠ¤': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì—°ì˜ˆ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì—°ì˜ˆ': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì—°ì˜ˆ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì„¸ê³„ ë‰´ìŠ¤': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì„¸ê³„ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì„¸ê³„': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì„¸ê³„ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì™¸êµ­': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì„¸ê³„ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ë‹¤ë¥¸ ë‚˜ë¼': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì„¸ê³„ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'êµ­ì œ': 'ë„¤ì´ë²„ ë‰´ìŠ¤ ì„¸ê³„ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•´ì¤˜',
      'ì‡¼í•‘': 'ì¿ íŒ¡ì—ì„œ ì¸ê¸° ìƒí’ˆ ê²€ìƒ‰í•´ì¤˜',
      'ê²€ìƒ‰': 'êµ¬ê¸€ì—ì„œ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”',
      'ì£¼ì‹': 'ë„¤ì´ë²„ ê¸ˆìœµì—ì„œ ì£¼ìš” ì£¼ì‹ ì‹œì„¸ ë³´ì—¬ì¤˜',
      'ì§€ë„': 'ë„¤ì´ë²„ ì§€ë„ì—ì„œ í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ ê²€ìƒ‰í•´ì¤˜',
      
      // ğŸ”¥ ìƒˆë¡œìš´ íŒ¨í„´: ì¹´í…Œê³ ë¦¬ ëª©ë¡ ìš”ì²­
      'ë‰´ìŠ¤ì— ë¬´ìŠ¨ ì¹´í…Œê³ ë¦¬': 'ë„¤ì´ë²„ ë‰´ìŠ¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë³´ì—¬ì¤˜',
      'ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬': 'ë„¤ì´ë²„ ë‰´ìŠ¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë³´ì—¬ì¤˜',
      'ì¹´í…Œê³ ë¦¬ ëª©ë¡': 'ë„¤ì´ë²„ ë‰´ìŠ¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë³´ì—¬ì¤˜',
      'ì–´ë–¤ ì¹´í…Œê³ ë¦¬': 'ë„¤ì´ë²„ ë‰´ìŠ¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë³´ì—¬ì¤˜',
      'ë¬´ìŠ¨ ì¹´í…Œê³ ë¦¬': 'ë„¤ì´ë²„ ë‰´ìŠ¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë³´ì—¬ì¤˜',
      
      // ğŸ”¥ ìƒˆë¡œìš´ íŒ¨í„´: ì½˜í…ì¸  ì¶”ì¶œ ë° ë¶„ì„ ìš”ì²­
      'ê²½ì œ ì£¼ìš” í—¤ë“œë¼ì¸': 'ê²½ì œ ì£¼ìš” í—¤ë“œë¼ì¸ë§Œ ë³´ì—¬ì¤˜',
      'ê²½ì œ í—¤ë“œë¼ì¸': 'ê²½ì œ ì£¼ìš” í—¤ë“œë¼ì¸ë§Œ ë³´ì—¬ì¤˜',
      'ê²½ì œ ë‰´ìŠ¤ ìš”ì•½': 'ê²½ì œ ë‰´ìŠ¤ ìš”ì•½í•´ì¤˜',
      'IT ì£¼ìš” ë‰´ìŠ¤': 'IT ì£¼ìš” ë‰´ìŠ¤ë§Œ ë³´ì—¬ì¤˜',
      'IT í—¤ë“œë¼ì¸': 'IT ì£¼ìš” í—¤ë“œë¼ì¸ë§Œ ë³´ì—¬ì¤˜',
      'ì •ì¹˜ ì£¼ìš” ë‰´ìŠ¤': 'ì •ì¹˜ ì£¼ìš” ë‰´ìŠ¤ë§Œ ë³´ì—¬ì¤˜',
      'ì •ì¹˜ í—¤ë“œë¼ì¸': 'ì •ì¹˜ ì£¼ìš” í—¤ë“œë¼ì¸ë§Œ ë³´ì—¬ì¤˜',
      'ì„¸ê³„ ì£¼ìš” ë‰´ìŠ¤': 'ì„¸ê³„ ì£¼ìš” ë‰´ìŠ¤ë§Œ ë³´ì—¬ì¤˜',
      'ì„¸ê³„ í—¤ë“œë¼ì¸': 'ì„¸ê³„ ì£¼ìš” í—¤ë“œë¼ì¸ë§Œ ë³´ì—¬ì¤˜'
    };
  }

  // ë¹ ë¥¸ íŒ¨í„´ ë§¤ì¹­ (AI ì‘ë‹µ ëŒ€ê¸° ì—†ì´) - ìš°ì„ ìˆœìœ„ ê¸°ë°˜ìœ¼ë¡œ ê°œì„ 
  static quickProcess(input) {
    const patterns = this.getCommonPatterns();
    const lowerInput = input.toLowerCase();

    // ğŸ” ìš”ì²­ ì˜ë„ ë¶„ì„
    const intent = this.analyzeIntent(input);
    console.log(`ğŸ¯ Intent analysis: ${intent.type} - ${intent.reason}`);

    // ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ íŒ¨í„´ë¶€í„° í™•ì¸ (ë” êµ¬ì²´ì ì¸ íŒ¨í„´ ìš°ì„ )
    const priorityPatterns = [
      // ì¹´í…Œê³ ë¦¬ë³„ ì£¼ìš” ë‰´ìŠ¤/í—¤ë“œë¼ì¸ ìš”ì²­ (ë†’ì€ ìš°ì„ ìˆœìœ„)
      'ê²½ì œ ì£¼ìš” í—¤ë“œë¼ì¸', 'IT ì£¼ìš” ë‰´ìŠ¤', 'ì •ì¹˜ ì£¼ìš” ë‰´ìŠ¤', 'ì„¸ê³„ ì£¼ìš” ë‰´ìŠ¤',
      'ê²½ì œ í—¤ë“œë¼ì¸', 'IT í—¤ë“œë¼ì¸', 'ì •ì¹˜ í—¤ë“œë¼ì¸', 'ì„¸ê³„ í—¤ë“œë¼ì¸',
      'ê²½ì œ ë‰´ìŠ¤ ìš”ì•½',
      
      // ì¹´í…Œê³ ë¦¬ ì´ë™ ìš”ì²­
      'ê²½ì œ', 'IT', 'ì •ì¹˜', 'ì‚¬íšŒ', 'ìŠ¤í¬ì¸ ', 'ì—°ì˜ˆ', 'ì„¸ê³„', 'ê³¼í•™',
      'ì •ì¹˜ê¸°ì‚¬', 'ê²½ì œê¸°ì‚¬', 'ITê¸°ì‚¬', 'ì„¸ê³„ ë‰´ìŠ¤', 'ì™¸êµ­', 'ë‹¤ë¥¸ ë‚˜ë¼', 'êµ­ì œ',
      
      // ì¼ë°˜ì ì¸ ë‰´ìŠ¤ ìš”ì²­
      'ë‰´ìŠ¤', 'ìµœì‹  ë‰´ìŠ¤', 'ë‰´ìŠ¤ ë³´ê¸°', 'ë‰´ìŠ¤ í™•ì¸'
    ];

    for (const pattern of priorityPatterns) {
      if (lowerInput.includes(pattern.toLowerCase())) {
        return {
          success: true,
          originalInput: input,
          processedCommand: patterns[pattern],
          method: 'priority-pattern-matching',
          intent: intent
        };
      }
    }

    return {
      success: false,
      originalInput: input,
      processedCommand: input,
      method: 'no-pattern',
      intent: intent
    };
  }

  // ğŸ” ìš”ì²­ ì˜ë„ ë¶„ì„
  static analyzeIntent(input) {
    const lowerInput = input.toLowerCase();
    
    // ì •ë³´ ìš”ì²­ íŒ¨í„´ (ì•Œê³  ì‹¶ë‹¤)
    const informationalPatterns = [
      'ì•Œë ¤ì¤˜', 'ë³´ì—¬ì¤˜', 'ìš”ì•½', 'í—¤ë“œë¼ì¸', 'ë‰´ìŠ¤', 'ì–´ë–¤ê°€', 'ë­ê°€', 'ë¬´ì—‡',
      'í˜„í™©', 'ìƒí™©', 'ìƒíƒœ', 'ê²°ê³¼', 'ë‚´ìš©', 'ì •ë³´'
    ];
    
    // ì•¡ì…˜ ìš”ì²­ íŒ¨í„´ (í•˜ê³  ì‹¶ë‹¤)
    const actionablePatterns = [
      'ì—´ì–´ì¤˜', 'ì´ë™í•´ì¤˜', 'ê°€ì¤˜', 'ë“¤ì–´ê°€ì¤˜', 'ì ‘ì†í•´ì¤˜', 'ë¡œê·¸ì¸í•´ì¤˜',
      'ê²€ìƒ‰í•´ì¤˜', 'ì°¾ì•„ì¤˜', 'ë³´ë‚´ì¤˜', 'ì‘ì„±í•´ì¤˜', 'ì‚­ì œí•´ì¤˜', 'ìˆ˜ì •í•´ì¤˜'
    ];
    
    // ì •ë³´ ìš”ì²­ì¸ì§€ í™•ì¸
    const isInformational = informationalPatterns.some(pattern => 
      lowerInput.includes(pattern)
    );
    
    // ì•¡ì…˜ ìš”ì²­ì¸ì§€ í™•ì¸  
    const isActionable = actionablePatterns.some(pattern => 
      lowerInput.includes(pattern)
    );
    
    if (isInformational && !isActionable) {
      return {
        type: 'informational',
        reason: 'ì‚¬ìš©ìê°€ ì •ë³´ë¥¼ ì•Œê³  ì‹¶ì–´í•¨ (ì½˜í…ì¸  ì¶”ì¶œ í›„ ì±„íŒ… ì‘ë‹µ)',
        browserMode: 'background'
      };
    } else if (isActionable) {
      return {
        type: 'actionable', 
        reason: 'ì‚¬ìš©ìê°€ ì›¹ì—ì„œ ì§ì ‘ ì•¡ì…˜ì„ ìˆ˜í–‰í•˜ê³  ì‹¶ì–´í•¨ (ë¸Œë¼ìš°ì € í¬ì–´ê·¸ë¼ìš´ë“œ)',
        browserMode: 'foreground'
      };
    } else {
      return {
        type: 'mixed',
        reason: 'ì˜ë„ê°€ ëª…í™•í•˜ì§€ ì•ŠìŒ (ê¸°ë³¸ê°’ìœ¼ë¡œ ì²˜ë¦¬)',
        browserMode: 'background'
      };
    }
  }
}
